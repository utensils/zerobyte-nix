# Repository Guidelines

## Project Structure & Module Organization
- `flake.nix` is the entry point for packages, dev shells, overlays, and modules.
- `nix/packages/` defines package derivations (`zerobyte.nix`, `shoutrrr.nix`) and the package set (`default.nix`).
- `nix/modules/` contains the NixOS module (`nixos.nix`) and experimental nix-darwin module (`darwin.nix`).
- `nix/tests/` holds NixOS VM integration tests (`integration.nix`).
- `nix/dev-shell.nix` defines the developer shell with bun/node tooling and helper utilities.
- `patches/` contains upstream patches applied during the build.
- `bun.nix` is generated by bun2nix and should be regenerated when dependencies change.

## Build, Test, and Development Commands
- `nix develop` enters the dev shell with bun, biome, typescript, restic, rclone, and bun2nix.
- `nix build .#zerobyte` builds the package derivation.
- `nix run .#zerobyte` runs the packaged server (useful for smoke checks).
- `nix flake check` runs integration checks (Linux only) and evaluates modules.
- `bun2nix -o bun.nix` regenerates `bun.nix` after bun dependency changes (run inside the dev shell).

## Coding Style & Naming Conventions
- Nix files use 2-space indentation and nixpkgs conventions for attrsets and options.
- Keep attribute names descriptive and aligned with module option names (e.g., `services.zerobyte.*`).
- Patch files in `patches/` should be numbered and described (e.g., `0001-...`).

## Testing Guidelines
- Integration testing uses the NixOS VM test in `nix/tests/integration.nix`.
- Run tests with `nix flake check` or `nix build .#checks.x86_64-linux.integration`.
- The test expects the service to listen on port `4096` and pass the `/healthcheck` endpoint.

## Commit & Pull Request Guidelines
- Commit messages currently follow Conventional Commits (example: `feat: initial zerobyte nix flake`).
- Keep commits focused and include context in the body when changing build logic or module options.
- PRs should include a short description, test evidence (command + result), and note any breaking changes.

## Security & Configuration Notes
- The NixOS module hardens the service; changes to capabilities or `ProtectSystem` should be justified.
- If adding new runtime dependencies, ensure they are included in the wrapper PATH in `nix/packages/zerobyte.nix`.
